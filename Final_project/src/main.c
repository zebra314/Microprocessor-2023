#include "stm32l476xx.h"
#include "helper_functions.h"
#include "led_button.h"
#include "max7219.h"
#include "timer.h"

// Check if the program is running
#define led_blink 

// Define pins for led (default use on-board led PA5)
#define LED_gpio GPIOA
#define LED_pin 5

// Define Counter timer
#define COUNTER_timer TIM2

// Define pins for MAX7219
#define MAX7219_gpio GPIOB
#define MAX7219_DIN 3
#define MAX7219_CS 4
#define MAX7219_CLK 5

#define CHAR_EMPTY 128

#ifdef led_blink
void SysTick_Handler() {
	if(SysTick->CTRL & SysTick_CTRL_COUNTFLAG_Msk){
		// Toggle LED display
		toggle_output(LED_gpio, LED_pin);
	}
#endif
}

int myfont[][8]={
		{0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000, }, //0
		{0x20>>2,0x60>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x70>>2}, //1
		{0x70>>2,0x88>>2,0x08>>2,0x10>>2,0x20>>2,0x40>>2,0x80>>2,0xF8>>2}, //2
		{0x70>>2,0x88>>2,0x08>>2,0x30>>2,0x08>>2,0x08>>2,0x88>>2,0x70>>2}, //3
		{0x10>>2,0x30>>2,0x50>>2,0x90>>2,0xF8>>2,0x10>>2,0x10>>2,0x10>>2}, //4
		{0xF8>>2,0x80>>2,0x80>>2,0xF0>>2,0x08>>2,0x08>>2,0x88>>2,0x70>>2}, //5
		{0x18>>2,0x20>>2,0x40>>2,0x80>>2,0xF0>>2,0x88>>2,0x88>>2,0x70>>2}, //6
		{0xF8>>2,0x08>>2,0x10>>2,0x20>>2,0x40>>2,0x40>>2,0x40>>2,0x40>>2}, //7
		{0x70>>2,0x88>>2,0x88>>2,0x70>>2,0x88>>2,0x88>>2,0x88>>2,0x70>>2}, //8
		{0x70>>2,0x88>>2,0x88>>2,0x88>>2,0x78>>2,0x08>>2,0x10>>2,0x60>>2}, //9
		{0x70>>2,0x88>>2,0x88>>2,0x88>>2,0xF8>>2,0x88>>2,0x88>>2,0x88>>2}, // A     ,10
		{0xF0>>2,0x88>>2,0x88>>2,0xF0>>2,0x88>>2,0x88>>2,0x88>>2,0xF0>>2}, // B     ,11
		{0x70>>2,0x88>>2,0x80>>2,0x80>>2,0x80>>2,0x80>>2,0x88>>2,0x70>>2}, // C		,12
		{0xE0>>2,0x90>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x90>>2,0xE0>>2}, // D		,13
		{0xF8>>2,0x80>>2,0x80>>2,0xF0>>2,0x80>>2,0x80>>2,0x80>>2,0xF8>>2}, // E		,14
		{0xF8>>2,0x80>>2,0x80>>2,0xF0>>2,0x80>>2,0x80>>2,0x80>>2,0x80>>2}, // F		,15
		{0x70>>2,0x88>>2,0x80>>2,0x80>>2,0xB8>>2,0x88>>2,0x88>>2,0x70>>2}, // G		,16
		{0x88>>2,0x88>>2,0x88>>2,0xF8>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2}, // H		,17
		{0xF8>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0xF8>>2}, // I		,18
		{0x08>>2,0x08>>2,0x08>>2,0x08>>2,0x08>>2,0x88>>2,0x88>>2,0x70>>2}, // J		,19
		{0x88>>2,0x90>>2,0xA0>>2,0xC0>>2,0xC0>>2,0xA0>>2,0x90>>2,0x88>>2}, // K		,20
		{0x80>>2,0x80>>2,0x80>>2,0x80>>2,0x80>>2,0x80>>2,0x80>>2,0xF8>>2}, // L		,21
		{0x88>>2,0xD8>>2,0xA8>>2,0xA8>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2}, // M		,22
		{0x88>>2,0xC8>>2,0xA8>>2,0xA8>>2,0x98>>2,0x88>>2,0x88>>2,0x88>>2}, // N		,23
		{0x70>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x70>>2}, // O		,24
		{0xF0>>2,0x88>>2,0x88>>2,0x88>>2,0xF0>>2,0x80>>2,0x80>>2,0x80>>2}, // P		,25
		{0x70>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0xA8>>2,0x90>>2,0x68>>2}, // Q		,26
		{0xF0>>2,0x88>>2,0x88>>2,0x88>>2,0xF0>>2,0xA0>>2,0x90>>2,0x88>>2}, // R		,27
		{0x78>>2,0x80>>2,0x80>>2,0x70>>2,0x08>>2,0x08>>2,0x08>>2,0xF0>>2}, // S		,28
		{0xF8>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2}, // T		,29
		{0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x70>>2}, // U     ,30
		{0x88>>2,0x88>>2,0x88>>2,0x88>>2,0x50>>2,0x50>>2,0x20>>2,0x20>>2}, // V		,31
		{0x88>>2,0x88>>2,0x88>>2,0x88>>2,0xA8>>2,0xA8>>2,0xD8>>2,0x88>>2}, // W		,32
		{0x88>>2,0x88>>2,0x50>>2,0x20>>2,0x20>>2,0x50>>2,0x88>>2,0x88>>2}, // X		,33
		{0x88>>2,0x88>>2,0x88>>2,0x50>>2,0x20>>2,0x20>>2,0x20>>2,0x20>>2}, // Y		,34
		{0xF8>>2,0x08>>2,0x10>>2,0x20>>2,0x20>>2,0x40>>2,0x80>>2,0xF8>>2}, // Z 	,35
};

int main()
{
	if(init_led(LED_gpio, LED_pin) != 0){
		// Fail to init led
		return -1;
	}
	if(init_max7219(MAX7219_gpio, MAX7219_DIN, MAX7219_CS, MAX7219_CLK) != 0){
		// Fail to init max7291
		return -1;
	}

	// Configure SysTick clk to 10 Mhz and interrupt every 0.4s
	SystemClock_Config_Interrupt(10, 4000000);

    while(1) {
		// for(int j = 0; j<36; j++){
			for(int i=0; i<8; i++){
				send_max7219(MAX7219_gpio, MAX7219_DIN, MAX7219_CS, MAX7219_CLK, i, myfont[0][i]);
			}
			delay_without_interrupt(300);
		// }

    }
    return 0;
}

